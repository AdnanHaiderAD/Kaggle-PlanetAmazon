\documentclass[11pt,a4paper]{article}

\usepackage[margin=2cm]{geometry}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{multirow}
\usepackage{amssymb}

\title{}

\begin{document}
\maketitle

Notation:
\begin{itemize}
\item $a\in\left\{\text{cloudy},\text{clear},\text{partial},\text{haze}\right\}$ represents the possible atmospheric conditions.
\item Vector $\bm{l}\in\left\{\left(\begin{matrix}1\\0\\0\\\vdots\end{matrix}\right),\left(\begin{matrix}0\\1\\0\\\vdots\end{matrix}\right),\left(\begin{matrix}1\\1\\0\\\vdots\end{matrix}\right),\cdots\right\}$ represents whether the other labels are present, such that $l_i\in\left\{0,1\right\}$ represents whether label $i$ is present.
\end{itemize}

We are interested in obtaining the joint posterior distribution, $P\left(a,\bm{l}\middle|\bm{o}_t\right)$. With this posterior, we can do training using either CE,
\[
\mathcal{F}_\text{CE}=-\sum_t\log P\left(a_t^*,\bm{l}_t^*\middle|\bm{o}_t\right),
\]
or maximum expected F-score,
\[
\mathcal{F}_\text{F}=-\sum_t\sum_{a,\bm{l}}F\left(a,\bm{l},a_t^*,\bm{l}_t^*\right)P\left(a,\bm{l}\middle|\bm{o}_t\right).
\]
With this posterior, we can also do decoding either MAP,
\[
a^*,\bm{l}^*=\arg\max_{a,\bm{l}}P\left(a,\bm{l}\middle|\bm{o}_t\right),
\]
or maximum expected F-score,
\[
a^*,\bm{l}^*=\arg\max_{a,\bm{l}}\sum_{a^\prime,\bm{l}^\prime}F\left(a^\prime,\bm{l}^\prime,a,\bm{l}\right)P\left(a^\prime,\bm{l}^\prime\middle|\bm{o}_t\right).
\]

\section{Obtaining the joint posterior distribution}

There are several possible ways that we can choose to formulate the posterior:
\begin{enumerate}
\item Sigmoid for $c\Rightarrow$ cloudy, softmax for $b\Rightarrow$ \{clear, partial, haze\}, and separate sigmoids for $\bm{l}\Rightarrow$ \{other labels\}. $b$ and $\bm{l}$ are conditionally independent given $c$.
\[
P\left(c,b,\bm{l}\middle|\bm{o}_t\right)=P\left(c\middle|\bm{o}_t\right)P\left(b\middle|c,\bm{o}_t\right)P\left(\bm{l}\middle|c,\bm{o}_t\right)
\]
\item Softmax for $a\Rightarrow$ \{cloudy, clear, partial, haze\} and separate sigmoids for $\bm{l}\Rightarrow$ \{other labels\}.
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=P\left(a\middle|\bm{o}_t\right)P\left(\bm{l}\middle|a,\bm{o}_t\right)
\]
\item Other labels are conditionally independent of the atmospheric condition.
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=P\left(a\middle|\bm{o}_t\right)P\left(\bm{l}\middle|\bm{o}_t\right)
\]
\end{enumerate}

\subsection{Group outputs into cloudy, \{clear, partial, haze\}, \{other labels\}}

We need to formulate the joint label probability, $P\left(c,b,\bm{l}\middle|\bm{o}_t\right)$. We can factorise the distribution into
\[
P\left(c,b,\bm{l}\middle|\bm{o}_t\right)=P\left(c\middle|\bm{o}_t\right)P\left(b\middle|c,\bm{o}_t\right)P\left(\bm{l}\middle|c,\bm{o}_t\right).
\]
Here, we have assumed that $b$ and $\bm{l}$ are conditionally independent.

We can then model $P\left(c\middle|\bm{o}_t\right)$ as a sigmoid output, $f\left(\bm{o}_t\right)$,
\begin{align*}
P\left(c\middle|\bm{o}_t\right)=f^c\left(\bm{o}_t\right)\left[1-f\left(\bm{o}_t\right)\right]^{1-c}.
\end{align*}
We can model $P\left(a\middle|c=1,\bm{o}_t\right)$ as a softmax output, $\bm{g}\left(\bm{o}_t\right)$, then we have
\[
P\left(b\middle|c,\bm{o}_t\right)=\left[\delta\left(b,0\right)\right]^cg_b^{1-c}\left(\bm{o}_t\right).
\]
It can be seen that there is a problem, because $0$ is not in the set of values that $b$ can take.

We assume that all other labels are independent of each other,
\[
P\left(\bm{l}\middle|c,\bm{o}_t\right)=\prod_iP\left(l_i\middle|c,\bm{o}_t\right).
\]
We can model $P\left(l_i\middle|c=1,\bm{o}_t\right)$ as a sigmoid, $h_i\left(\bm{o}_t\right)$, then we have
\[
P\left(l_i\middle|c,\bm{o}_t\right)=\left[\delta\left(l_i,0\right)\right]^c\left[h_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}\right]^{1-c}.
\]
The joint distribution is
\begin{align*}
P\left(c,b,\bm{l}\middle|\bm{o}_t\right)=f^c\left(\bm{o}_t\right)\left[1-f\left(\bm{o}_t\right)\right]^{1-c}\left[\delta\left(b,0\right)\right]^cg_b^{1-c}\left(\bm{o}_t\right)\prod_i\left[\delta\left(l_i,0\right)\right]^c\left[h_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}\right]^{1-c}.
\end{align*}
The CE criterion for frame $t$ is
\begin{align*}
\mathcal{F}_\text{CE}=&-\log P\left(c_t^*,b_t^*,\bm{l}_t^*\middle|\bm{o}_t\right)\\
=&-c_t^*\log f\left(\bm{o}_t\right)-\left(1-c_t^*\right)\log \left[1-f\left(\bm{o}_t\right)\right]-c_t^*\log\delta\left(b_t^*,0\right)-\left(1-c_t^*\right)g_{b_t^*}\left(\bm{o}_t\right)\\
&-\sum_i\left\{c_t^*\log\delta\left(l_{it}^*,0\right)+\left(1-c_t^*\right)\left[l_{it}^*\log h_i\left(\bm{o}_t\right)+\left(1-l_{it}^*\right)\log\left(1-h_i\left(\bm{o}_t\right)\right)\right]\right\}
\end{align*}
There is a problem, because $b$ cannot take the value 0. So, $\log\delta\left(b,0\right)$ is always infinite. However, the gradient is still finite, as $\log\delta\left(b,0\right)$ is not involved in the gradient. When we discard all the terms that do not depend on the model parameters, the criterion reduces to
\[
\mathcal{F}_\text{CE}\Rightarrow-c_t^*\log f\left(\bm{o}_t\right)-\left(1-c_t^*\right)\log \left[1-f\left(\bm{o}_t\right)\right]-\left(1-c_t^*\right)\sum_i\left[l_{it}^*\log h_i\left(\bm{o}_t\right)+\left(1-l_{it}^*\right)\log\left[1-h_i\left(\bm{o}_t\right)\right]\right].
\]

\clearpage
\subsection{Group outputs into \{atmophere\}, \{other labels\}}

To avoid the infinite CE cost, we can instead group together all four atmospheric conditions into a single softmax output. The joint posterior can then be factorised as
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=P\left(a\middle|\bm{o}_t\right)P\left(\bm{l}\middle|a,\bm{o}_t\right).
\]

We can model $P\left(a\middle|\bm{o}_t\right)$ as a softmax, $\bm{g}\left(\bm{o}_t\right)$,
\[
P\left(a\middle|\bm{o}_t\right)=g_a\left(\bm{o}_t\right).
\]
We can again model $P\left(\bm{l}\middle|a,\bm{o}_t\right)=\prod\limits_iP\left(l_i\middle|a,\bm{o}_t\right)$ as separate sigmoids, $h_i\left(\bm{o}_t\right)$, then we have
\[
P\left(l_i\middle|a,\bm{o}_t\right)=\left[\delta\left(l_i,0\right)\right]^{\delta\left(a,\text{cloudy}\right)}\left[h_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}\right]^{1-\delta\left(a,\text{cloudy}\right)}.
\]
The joint distribution is
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=g_a\left(\bm{o}_t\right)\prod_i\left[\delta\left(l_i,0\right)\right]^{\delta\left(a,\text{cloudy}\right)}\left[h_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}\right]^{1-\delta\left(a,\text{cloudy}\right)}.
\]
The CE criterion for frame $t$ is
\[
\mathcal{F}_\text{CE}=-\log g_{a_t^*}\left(\bm{o}_t\right)-\sum_i\left\{\delta\left(a_t^*,\text{cloudy}\right)\log\delta\left(l_{it}^*,0\right)+\left[1-\delta\left(a_t^*,\text{cloudy}\right)\right]\left[l_{it}^*\log h_i\left(\bm{o}_t\right)+\left(1-l_{it}^*\right)\log\left(1-h_i\left(\bm{o}_t\right)\right)\right]\right\}
\]
By discarding all the terms that do not depend on the model parameters, the criterion reduces to
\[
\mathcal{F}_\text{CE}\Rightarrow-\log g_{a_t^*}\left(\bm{o}_t\right)-\left[1-\delta\left(a_t^*,\text{cloudy}\right)\right]\sum_i\left[l_{it}^*\log h_i\left(\bm{o}_t\right)+\left(1-l_{it}^*\right)\log\left(1-h_i\left(\bm{o}_t\right)\right)\right].
\]

\clearpage
\subsection{Conditionally independent $a$ and $\bm{l}$}

Although the task instructions mentions that images labelled with cloudy should not have any other labels, labelling errors do exists in the training set. It may be possible that labelling errors also exist in the test set. If this is the case it may be better not to force $P\left(\bm{l}=\bm{0}\middle|a=\text{cloudy},\bm{o}_t\right)=1$. We can remove this constraint by assuming that $a$ and $\bm{l}$ are conditionally independent, so that the joint posterior factorises into
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=P\left(a\middle|\bm{o}_t\right)P\left(\bm{l}\middle|\bm{o}-t\right).
\]
We can again model $P\left(a\middle|\bm{o}_t\right)$ as a softmax,
\[
P\left(a\middle|\bm{o}_t\right)=g_a\left(\bm{o}_t\right).
\]
We can model $P\left(\bm{l}\middle|\bm{o}-t\right)=\prod\limits_iP\left(l_i\middle|\bm{o}-t\right)$ as separate sigmoids, regardless of the atmospheric condition,
\[
P\left(l_i\middle|\bm{o}_t\right)=h_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}.
\]
The joint posterior is then
\[
P\left(a,\bm{l}\middle|\bm{o}_t\right)=g_a\left(\bm{o}_t\right)\prod_ih_i^{l_i}\left(\bm{o}_t\right)\left\{1-h_i\left(\bm{o}_t\right)\right\}^{1-l_i}.
\]
The CE criterion for frame $t$ is
\[
\mathcal{F}_\text{CE}=-\log g_{a_t^*}\left(\bm{o}_t\right)-\sum_i\left\{l_{it}^*\log h_i\left(\bm{o}_t\right)+\left(1-l_{it}^*\right)\log\left[1-h_i\left(\bm{o}_t\right)\right]\right\}.
\]

\end{document}
